LISP?= sbcl

TFLAGS = --non-interactive \
	--eval '(ql:quickload :ahungry-fleece)' \
	--eval '(af.run.tests:main)'

CFLAGS = --disable-debugger \
	--eval '(sb-ext:save-lisp-and-die "bin/ahungry-fleece.core")'

EFLAGS = --disable-debugger \
	--eval '(ql:quickload :ahungry-fleece)' \
	--eval '(sb-ext:save-lisp-and-die "bin/ahungry-fleece" :executable t)'

CORE = bin/ahungry-fleece.core
EXE = bin/ahungry-fleece

all: $(EXE)

$(CORE):
	$(LISP) $(CFLAGS)

$(EXE): $(CORE)
	$(LISP) --core $< $(EFLAGS)

test: $(EXE)
	$< $(TFLAGS)

clean:
	-rm $(CORE)
	-rm $(EXE)
